# 帖子关注系统设计

本文档详细介绍论坛数据分析系统中的帖子关注功能设计和实现。

## 系统概述

帖子关注系统允许用户关注感兴趣的帖子和标记自己的帖子，方便追踪帖子更新状态和历史变化。系统提供两种不同类型的关注：

1. **我的关注**：用户感兴趣的、希望持续关注的帖子
2. **我的帖子**：用户自己发布的或特别标记的帖子

## 数据结构

### 数据表设计

关注系统主要基于`thread_follow`表实现，表结构如下：

| 字段名 | 类型 | 说明 |
|-------|------|------|
| id | INTEGER | 自增主键 |
| thread_id | TEXT | 帖子ID |
| url | TEXT | 帖子URL |
| title | TEXT | 帖子标题 |
| author | TEXT | 作者名 |
| author_link | TEXT | 作者链接 |
| type | TEXT | 关注类型：'my_follow'(我的关注)或'marked'(我的帖子) |
| follow_status | TEXT | 关注状态，默认为'active' |
| days_old | INTEGER | 已发布天数 |
| last_active | TEXT | 最后活跃（如"3天前"） |
| repost_count | INTEGER | 重发次数 |
| reply_count | INTEGER | 回复数 |
| delete_reply_count | INTEGER | 删除回复次数 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

### 与其他表的关联

`thread_follows`表通过`thread_id`字段与以下表关联：

- `post_ranking`：获取帖子的最新统计数据
- `post_history`：获取帖子的历史变更记录

## 功能实现

### 前端实现

前端实现主要包括以下组件：

1. **关注列表页面**
   - `ThreadFollowTable.js`：显示关注的帖子列表
   - `ThreadFollowList.js`：显示我的帖子列表
   - 支持分页、过滤和排序

2. **关注操作组件**
   - 在帖子排行榜中添加关注按钮
   - 在关注列表中添加取消关注按钮
   - 在帖子详情页添加关注功能

3. **更新历史查看**
   - 使用`UpdateHistoryButton`组件展示帖子历史变更
   - 在hover状态下预览简要历史
   - 点击后查看完整历史记录

### 后端实现

后端API实现主要包括：

1. **获取关注列表**
   - `GET /api/thread-follows`
   - 参数：type（关注类型）、page、page_size
   - 返回分页结果

2. **添加关注**
   - `POST /api/thread-follows`
   - 接收帖子信息和关注类型
   - 创建关注记录

3. **取消关注**
   - `DELETE /api/thread-follows`
   - 根据thread_id和type删除关注记录

4. **更新数据保护**
   - 在`update_db.py`中将`thread_follows`表添加到受保护表列表
   - 确保数据库更新不会影响用户的关注数据

## 数据更新机制

关注系统的数据更新采用以下机制：

1. **实时更新**
   - 用户添加或取消关注时，立即更新数据库
   - 前端显示最新状态

2. **自动同步**
   - 系统自动同步关注帖子的最新数据
   - 包括回复数、重发次数、最后活跃时间等

3. **数据保护**
   - 在数据库更新过程中，关注数据作为用户数据受到保护
   - `thread_follows`表被添加到`protected_tables`列表中
   - 更新脚本在创建临时数据库时会复制此表的所有数据
   - 确保系统自动更新不会丢失用户的关注记录

4. **表结构完整性**
   - 更新脚本会自动检查并确保`thread_follows`表有正确的列结构
   - 如果缺少`days_old`或`last_active`列，会自动添加并设置默认值
   - 创建必要的索引以提高查询性能：`idx_thread_follows_user_id`、`idx_thread_follows_thread_id`和`idx_thread_follows_thread_url`

## 用户界面

### 关注列表页面

关注列表页面提供以下功能：

- 查看所有关注的帖子
- 查看帖子的最新状态（回复数、重发次数等）
- 查看帖子活跃度（最后活跃时间）
- 取消关注

### 更新历史查看

每个关注的帖子都提供更新历史查看功能：

- 通过时间机器图标按钮访问
- 悬停预览简要历史记录
- 点击查看完整历史记录

## 接口文档

详细的API接口文档请参考[API参考文档](./db_api_reference.md)中的"关注功能API"部分。

## 数据维护

为确保关注数据的完整性和安全，系统采取以下措施：

1. **数据备份**
   - 关注数据作为用户数据包含在常规备份中
   - 支持数据恢复

2. **数据保护**
   - 在`update_db.py`中将`thread_follows`表设为受保护表
   - 确保系统更新不会覆盖用户数据

## 未来改进计划

1. **关注分组**
   - 支持将关注的帖子分组管理
   - 添加标签和备注功能

2. **通知功能**
   - 当关注的帖子有更新时发送通知
   - 支持邮件或浏览器推送通知

3. **数据分析**
   - 提供关注帖子的统计分析
   - 可视化展示帖子活跃度趋势 