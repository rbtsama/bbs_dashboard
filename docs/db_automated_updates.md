# 数据库自动更新流程

本文档详细描述了论坛数据库的自动更新流程，包括设置过程、执行步骤、错误处理和监控机制。

## 概述

数据库自动更新系统每天凌晨3点（加州时间）自动执行，完成从原始数据处理到数据库更新的全流程。整个过程分为五个主要步骤：

1. **数据预处理**：处理原始抓取数据，生成标准格式文件
2. **数据分析**：执行统计分析，生成导入数据
3. **数据导入**：将处理后的数据导入数据库
4. **词云生成**：更新词云数据
5. **数据备份**：创建数据库备份

## 自动更新流程设置

### 先决条件

- Windows操作系统
- PowerShell 5.0或更高版本
- 管理员权限（设置计划任务需要）
- Python 3.6或更高版本，以及所有必要的依赖项

### 设置步骤

1. **创建脚本目录结构**

   确保项目目录下存在以下目录：
   - `scripts/`：存放自动化脚本
   - `logs/`：存放执行日志

2. **复制自动更新脚本**

   将以下两个脚本放入`scripts/`目录：
   - `auto_update_db.ps1`：主执行脚本，执行完整的更新流程
   - `register_scheduled_task.ps1`：注册Windows计划任务的脚本

3. **注册计划任务**

   以管理员身份运行PowerShell，并执行以下命令：
   ```powershell
   cd 项目根目录
   .\scripts\register_scheduled_task.ps1
   ```

   此命令会创建一个名为"BBS数据库每日更新"的Windows计划任务，设置为每天凌晨3点（加州时间）执行。

## 自动更新脚本详解

### 主要组件

1. **auto_update_db.ps1**

   此脚本是自动更新的核心，负责执行完整的更新流程。主要功能包括：
   
   - 设置日志记录
   - 定义执行步骤
   - 处理错误并继续执行后续步骤
   - 生成执行状态报告

2. **register_scheduled_task.ps1**

   此脚本负责注册Windows计划任务，确保自动更新脚本按计划执行。主要功能包括：
   
   - 检查管理员权限
   - 计算时区差异，确保在加州凌晨3点执行
   - 创建或更新计划任务

### 执行流程详解

1. **初始化**
   - 设置工作目录为项目根目录
   - 初始化日志记录
   - 创建状态跟踪对象

2. **数据预处理**
   - 执行`post.py`：处理新发帖数据，生成`post.xlsx`
   - 执行`update.py`：处理帖子更新数据，生成`update.xlsx`
   - 执行`detail.py`：处理帖子详情数据，生成`detail.xlsx`
   - 执行`action.py`：生成帖子动态记录，生成`action.csv`
   - 执行`car_info.py`：处理车辆信息数据，生成`car_info.csv`

3. **数据分析**
   - 执行`analysis.py`：数据分析，生成统计数据
   - 执行`test_data_quality.py`：数据质量测试，验证数据一致性

4. **数据导入**
   - 执行`update_db.py`：数据库更新，将处理后的数据导入数据库
   - 执行`check_db_structure.py`：检查数据库结构，确保表结构正确

5. **词云生成**
   - 执行`generate_wordcloud.py`：生成词云数据，更新词云缓存

6. **数据备份**
   - 执行`backup_db.py`：创建数据库备份，管理备份历史

### 错误处理机制

自动更新脚本实现了健壮的错误处理机制：

1. **步骤级错误处理**
   - 每个步骤独立try-catch，错误不会中断整个流程
   - 详细记录错误信息，包括异常消息和堆栈跟踪
   - 更新步骤状态，便于后续分析

2. **关键步骤失败处理**
   - 对于数据导入等关键步骤，失败时会停止后续处理
   - 非关键步骤失败时会继续执行后续步骤
   - 生成最终执行报告，列出所有失败步骤

3. **退出代码**
   - 成功执行：返回0
   - 部分步骤失败：返回1
   - 这些退出代码可用于外部监控系统

## 监控和日志记录

系统实现了全面的监控和日志记录机制：

1. **详细日志**
   - 记录每个步骤的开始和结束时间
   - 记录每个Python脚本的执行状态
   - 保存详细的错误信息
   - 日志文件命名格式：`auto_update_db_YYYYMMDD_HHMMSS.log`

2. **执行状态报告**
   - 在执行结束时生成完整的状态报告
   - 报告包含每个步骤的状态和执行时间
   - 对于失败的步骤，包含详细的错误信息

3. **外部监控集成**
   - 通过退出代码支持外部监控系统
   - 可以通过检查日志文件实现自动告警

## 手动执行

如需手动执行自动更新流程，可以按以下步骤操作：

1. 打开PowerShell
2. 导航到项目根目录
3. 执行以下命令：
   ```powershell
   .\scripts\auto_update_db.ps1
   ```

## 故障排除

1. **计划任务未执行**
   - 检查任务计划程序中任务状态
   - 验证系统时间和时区设置
   - 检查执行账户权限

2. **脚本执行失败**
   - 查看日志文件了解具体错误
   - 检查Python环境和依赖项
   - 验证数据文件是否存在和格式正确

3. **数据更新不完整**
   - 检查各个步骤的执行状态
   - 验证原始数据文件的完整性
   - 检查数据库连接和权限

## 相关文档

- [数据库概览](./db_overview.md)
- [数据处理流程](./db_data_processing.md)
- [增量数据更新](./db_incremental_updates.md)
- [数据版本控制](./db_version_control.md)
- [数据备份与恢复](./db_backup_recovery.md) 