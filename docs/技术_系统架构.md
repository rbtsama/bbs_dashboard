# 系统架构设计

本文档详细描述论坛数据洞察平台的技术架构、核心组件和数据流，为开发人员提供系统整体结构的理解。

## 系统整体架构

论坛数据洞察平台采用前后端分离的架构设计，由以下主要部分组成：

```
+------------------+       +------------------+       +------------------+
|                  |       |                  |       |                  |
|  前端应用        | <---> |  后端API服务     | <---> |  数据处理模块    |
|                  |       |                  |       |                  |
+------------------+       +------------------+       +------------------+
         ^                         ^                          ^
         |                         |                          |
         v                         v                          v
+------------------+       +------------------+       +------------------+
|                  |       |                  |       |                  |
|  用户界面        |       |  数据库          |       |  原始数据源      |
|                  |       |                  |       |                  |
+------------------+       +------------------+       +------------------+
```

### 技术栈概览

- **前端**：React/Next.js + Tailwind CSS
- **后端**：Python Flask + SQLite
- **数据处理**：Python (Pandas, NumPy, NLTK)
- **部署环境**：Vercel (前端) + Vercel Serverless Functions (API)

## 前端架构

前端采用React/Next.js框架，实现了响应式设计和数据可视化功能。

### 核心组件

```
/frontend
  ├── /components            # 可复用UI组件
  │   ├── /charts            # 图表组件
  │   ├── /layout            # 布局组件
  │   ├── /dashboard         # 仪表盘组件
  │   └── /widgets           # 小部件组件
  │
  ├── /pages                 # 页面组件
  │   ├── /index.js          # 主页面
  │   ├── /dashboard.js      # 数据仪表盘
  │   ├── /ranking.js        # 排行榜
  │   ├── /tracking.js       # 历史追踪
  │   ├── /targets.js        # 目标追踪
  │   ├── /wordcloud.js      # 词云分析
  │   └── /admin/db-update.js # 管理员页面
  │
  ├── /api                   # API封装
  │   ├── /client.js         # API客户端
  │   └── /endpoints.js      # API端点定义
  │
  ├── /context               # React上下文
  │   └── /authContext.js    # 认证上下文
  │
  ├── /hooks                 # 自定义Hooks
  │   ├── /useFetch.js       # 数据获取Hook
  │   └── /useAuth.js        # 认证Hook
  │
  └── /utils                 # 工具函数
      ├── /formatting.js     # 数据格式化
      └── /validation.js     # 数据验证
```

### 数据流

1. 用户通过浏览器访问应用
2. 前端组件通过API客户端获取数据
3. 数据在前端进行可视化处理和展示
4. 用户交互触发状态更新和新的API请求

## 后端架构

后端基于Python Flask框架，提供RESTful API服务。

### 核心组件

```
/backend
  ├── /app.py               # 主应用入口
  ├── /db                   # 数据库目录
  │   └── /forum_data.db    # SQLite数据库
  ├── /modules              # 模块化API
  │   ├── /posts.py         # 帖子API
  │   ├── /authors.py       # 作者API
  │   ├── /statistics.py    # 统计API
  │   ├── /tracking.py      # 追踪API
  │   ├── /wordcloud.py     # 词云API
  │   └── /car_info.py      # 车辆信息API
  │
  ├── /services             # 业务服务
  │   ├── /db_service.py    # 数据库服务
  │   └── /auth_service.py  # 认证服务
  │
  ├── /tools                # 实用工具
  │   ├── /validators.py    # 数据验证
  │   └── /formatters.py    # 格式化工具
  |
  └── /sql                  # SQL查询
      ├── /schema.sql       # 数据库结构
      └── /queries.sql      # 常用查询

/py
  ├── /post.py               # 发帖数据处理
  ├── /update.py             # 更新数据处理
  ├── /detail.py             # 详情数据处理
  ├── /action.py             # 动作数据生成
  ├── /car_info.py           # 车辆信息提取与标准化
  ├── /analysis.py           # 数据分析
  ├── /update_db.py          # 数据库更新
  ├── /generate_wordcloud.py # 词云生成
  ├── /backup_db.py          # 数据库备份
  └── /rollback_db.py        # 数据库回滚
```

### API端点设计

```
GET  /api/status                   # 系统状态
GET  /api/dashboard                # 仪表盘数据
GET  /api/posts                    # 获取帖子列表
GET  /api/posts/:id                # 获取单个帖子
GET  /api/posts/:id/actions        # 获取帖子动作历史
GET  /api/ranking/posts            # 获取帖子排行
GET  /api/ranking/authors          # 获取作者排行
GET  /api/tracking/history         # 获取历史数据
GET  /api/tracking/targets         # 获取追踪目标
POST /api/tracking/targets         # 添加追踪目标
DEL  /api/tracking/targets/:id     # 删除追踪目标
GET  /api/wordcloud/:type          # 获取词云数据
GET  /api/car-info                 # 获取车辆信息
POST /api/db-update                # 触发数据库更新
```

### 数据流程

1. 从原始Excel文件读取数据
2. 数据清洗和预处理
3. 特征提取和数据分析
4. 生成派生数据（如动作记录、车辆信息）
   - 帖子动作记录：基于更新列表生成帖子的活动记录
   - 车辆信息提取：从帖子内容中识别和标准化车辆信息
5. 将处理后的数据导入SQLite数据库
6. 生成分析结果和可视化数据（如词云）
7. 通过API接口提供数据访问服务

## 数据处理模块

数据处理模块负责原始数据的预处理、分析和导入数据库。

### 核心组件

```
/py
  ├── /post.py               # 发帖数据处理
  ├── /update.py             # 更新数据处理
  ├── /detail.py             # 详情数据处理
  ├── /action.py             # 动作数据生成
  ├── /car_info.py           # 车辆信息提取与标准化
  ├── /analysis.py           # 数据分析
  ├── /update_db.py          # 数据库更新
  ├── /generate_wordcloud.py # 词云生成
  ├── /backup_db.py          # 数据库备份
  └── /rollback_db.py        # 数据库回滚
```

### 数据流程

1. 从原始Excel文件读取数据
2. 数据清洗和预处理
3. 特征提取和数据分析
4. 生成派生数据（如动作记录、车辆信息）
   - 帖子动作记录：基于更新列表生成帖子的活动记录
   - 车辆信息提取：从帖子内容中识别和标准化车辆信息
5. 将处理后的数据导入SQLite数据库
6. 生成分析结果和可视化数据（如词云）

## 数据库设计

系统使用SQLite作为数据存储，主要表结构如下：

### 主要表结构

```
posts                   # 帖子基本信息
  ├── id                # 主键
  ├── url               # 帖子URL
  ├── title             # 标题
  ├── author            # 作者
  ├── created_at        # 创建时间
  └── updated_at        # 更新时间

post_details            # 帖子详细信息
  ├── id                # 主键
  ├── post_id           # 外键(posts.id)
  ├── content           # 内容
  ├── image_count       # 图片数量
  ├── view_count        # 浏览数
  └── likes             # 点赞数

post_history            # 帖子历史记录
  ├── id                # 主键
  ├── thread_id         # 帖子ID
  ├── url               # 帖子URL
  ├── title             # 标题
  ├── author            # 作者
  ├── action            # 动作类型
  ├── timestamp         # 时间戳
  └── details           # 详细信息

post_ranking            # 帖子排名表
  ├── id                # 主键
  ├── url               # 帖子URL
  ├── title             # 标题
  ├── read_count        # 阅读数
  ├── reply_count       # 回复数
  ├── last_active       # 最后活动时间
  └── days_old          # 帖龄

author_ranking          # 作者排名表
  ├── id                # 主键
  ├── author            # 作者名
  ├── post_count        # 发帖数
  ├── reply_count       # 回复数
  ├── activity_score    # 活跃度
  └── last_active       # 最后活动时间

tracking_targets        # 追踪目标表
  ├── id                # 主键
  ├── url               # 帖子URL
  ├── title             # 标题
  ├── created_at        # 创建时间
  └── notes             # 备注

car_info                # 车辆信息表
  ├── id                # 主键
  ├── post_id           # 外键(posts.id)
  ├── make              # 品牌
  ├── model             # 型号
  ├── year              # 年份
  ├── price             # 价格
  └── features          # 特性
```

### 数据关系图

```
+---------------+       +----------------+       +----------------+
|               |       |                |       |                |
|    posts      | 1---* |  post_details  | *---1 |  car_info      |
|               |       |                |       |                |
+---------------+       +----------------+       +----------------+
        |
        | 1
        |
        * *
+---------------+       +----------------+       +----------------+
|               |       |                |       |                |
| post_history  | *---* | post_ranking   | *---* | author_ranking |
|               |       |                |       |                |
+---------------+       +----------------+       +----------------+
                                |
                                | *
                                |
                        +----------------+
                        |                |
                        |tracking_targets|
                        |                |
                        +----------------+
```

## 自动化更新架构

系统支持两种自动化更新方式，分别为Vercel环境和Windows环境：

### Vercel环境自动化更新

```
+------------------+       +------------------+       +------------------+
|                  |       |                  |       |                  |
|  外部定时服务    | ----> |  Vercel API端点  | ----> |  数据处理流程    |
| (cron-job.org)   |       | (/api/db-update) |       |                  |
+------------------+       +------------------+       +------------------+
                                    |                         |
                                    v                         v
                           +------------------+      +------------------+
                           |                  |      |                  |
                           |  状态监控页面    |      |  数据库备份/回滚 |
                           |                  |      |                  |
                           +------------------+      +------------------+
```

### Windows环境自动化更新

```
+------------------+       +------------------+       +------------------+
|                  |       |                  |       |                  |
| Windows计划任务  | ----> | PowerShell脚本   | ----> |  数据处理流程    |
|                  |       |                  |       |                  |
+------------------+       +------------------+       +------------------+
                                    |                         |
                                    v                         v
                           +------------------+      +------------------+
                           |                  |      |                  |
                           |  日志文件        |      |  数据库备份/回滚 |
                           |                  |      |                  |
                           +------------------+      +------------------+
```

## 部署架构

系统采用Vercel平台部署，整体部署架构如下：

```
                    +------------------+
                    |                  |
用户浏览器 -------> |  Vercel平台      |
                    |                  |
                    +------------------+
                            |
                            |
         +------------------+------------------+
         |                                     |
         v                                     v
+------------------+                 +------------------+
|                  |                 |                  |
| Next.js静态页面  |                 | Serverless函数   |
| (前端应用)       |                 | (API端点)        |
+------------------+                 +------------------+
                                              |
                                              v
                                     +------------------+
                                     |                  |
                                     | SQLite数据库     |
                                     | (Vercel储存)     |
                                     +------------------+
```

## 安全架构

系统采用多层次安全防护措施：

1. **API访问控制**：使用密钥保护管理员API
2. **数据防护**：定期备份和数据验证
3. **错误处理**：错误日志记录和监控
4. **回滚机制**：自动化回滚保护数据完整性

## 扩展性设计

系统设计支持以下扩展方向：

1. **数据源扩展**：支持添加更多论坛数据源
2. **分析算法扩展**：可添加新的分析模块
3. **可视化扩展**：增加更多可视化图表类型
4. **用户功能扩展**：添加更多用户交互功能

## 性能优化

系统设计中的性能优化考虑：

1. **静态生成**：利用Next.js静态生成加速页面加载
2. **数据缓存**：在API层实现数据缓存
3. **批量处理**：大数据集使用批量处理避免内存溢出
4. **数据库索引**：优化SQLite查询性能的索引设计

## 系统限制

当前系统存在一些限制和约束：

1. **数据规模**：SQLite适合中小规模数据，大规模数据可能需要迁移至其他数据库
2. **并发处理**：SQLite对并发写入支持有限
3. **处理能力**：Vercel Serverless函数有执行时间限制
4. **存储限制**：Vercel平台对存储空间有限制

---

通过本文档，开发人员可以了解系统的整体架构和各组件间的关系，为开发和维护工作提供指导。系统架构会随着需求变化而演进，本文档将定期更新以反映最新的架构设计。 